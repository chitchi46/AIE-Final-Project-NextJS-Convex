name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, "feature/*" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆgit filter-repoã®ãŸã‚ï¼‰

      - name: Check for sensitive data patterns
        run: |
          # æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” Scanning for sensitive information..."
          
          # å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©
          PATTERNS=(
            "sk-[a-zA-Z0-9]{20,}"
            "sk-proj-[a-zA-Z0-9]{40,}"
            "your-secret-key-for-jwt-authentication"
            "cnx_[a-zA-Z0-9]{20,}"
            "Bearer\s+[A-Za-z0-9+/]{40,}={0,2}"
          )
          
          # å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          for pattern in "${PATTERNS[@]}"; do
            if git grep -E "$pattern" -- '*.js' '*.ts' '*.tsx' '*.json' ':!*.example' ':!*test*'; then
              echo "âŒ Sensitive information pattern detected: $pattern"
              exit 1
            fi
          done
          
          echo "âœ… No sensitive information detected"

      - name: Check for forbidden files
        run: |
          # ç¦æ­¢ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          FORBIDDEN=(
            ".env"
            ".env.local"
            ".env.production"
            "cookies.txt"
            "*.pem"
            "*.key"
            "*.cert"
          )
          
          for file in "${FORBIDDEN[@]}"; do
            if find . -name "$file" -not -path "*/node_modules/*" | grep -q .; then
              echo "âŒ Forbidden file found: $file"
              exit 1
            fi
          done
          
          echo "âœ… No forbidden files found"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: security-scan
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: nextjs-app/package-lock.json

      - name: Install dependencies
        working-directory: ./nextjs-app
        run: npm ci

      - name: Run linter
        working-directory: ./nextjs-app
        run: npm run lint

      - name: Run tests
        working-directory: ./nextjs-app
        env:
          JWT_SECRET: "test-secret-key-for-ci-environment-only-32-chars"
          NEXT_PUBLIC_CONVEX_URL: "https://test.convex.cloud"
          CONVEX_DEPLOYMENT: "test"
        run: npm test -- --passWithNoTests

      - name: Build application
        working-directory: ./nextjs-app
        env:
          JWT_SECRET: "test-secret-key-for-ci-environment-only-32-chars"
          NEXT_PUBLIC_CONVEX_URL: "https://test.convex.cloud"
          CONVEX_DEPLOYMENT: "test"
        run: npm run build

  validate-env-example:
    name: Validate Environment Example
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check .env.example exists
        run: |
          if [ ! -f "nextjs-app/.env.example" ]; then
            echo "âŒ .env.example file is missing!"
            exit 1
          fi
          echo "âœ… .env.example file exists"

      - name: Validate .env.example format
        run: |
          # å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          REQUIRED_VARS=(
            "JWT_SECRET"
            "NEXT_PUBLIC_CONVEX_URL"
            "CONVEX_DEPLOYMENT"
            "OPENAI_API_KEY"
          )
          
          for var in "${REQUIRED_VARS[@]}"; do
            if ! grep -q "^${var}=" nextjs-app/.env.example; then
              echo "âŒ Missing required variable in .env.example: $var"
              exit 1
            fi
          done
          
          echo "âœ… All required variables found in .env.example"

      - name: Check for real secrets in .env.example
        run: |
          # .env.exampleã«å®Ÿéš›ã®ç§˜å¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if grep -E "sk-[a-zA-Z0-9]{20,}" nextjs-app/.env.example; then
            echo "âŒ Real API key found in .env.example!"
            exit 1
          fi
          
          if grep -E "cnx_[a-zA-Z0-9]{20,}" nextjs-app/.env.example; then
            echo "âŒ Real Convex key found in .env.example!"
            exit 1
          fi
          
          echo "âœ… No real secrets found in .env.example" 