#!/bin/sh

# æ©Ÿå¯†æƒ…å ±ã®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
echo "ğŸ” Checking for sensitive information..."

# åŸºæœ¬çš„ãªæ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
SENSITIVE_PATTERNS=(
  # JWT Secretï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
  "your-secret-key-for-jwt-authentication"
  
  # OpenAI APIã‚­ãƒ¼
  "sk-[a-zA-Z0-9]{20,}"
  "sk-proj-[a-zA-Z0-9]{40,}"
  
  # Convexé–¢é€£
  "cnx_[a-zA-Z0-9]{20,}"
  
  # ä¸€èˆ¬çš„ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
  "token[\"']\s*[:=]\s*[\"'][a-zA-Z0-9_\-]{20,}"
  "secret[\"']\s*[:=]\s*[\"'][a-zA-Z0-9_\-]{20,}"
  "password[\"']\s*[:=]\s*[\"'][^\"']{8,}"
  
  # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ±
  "Bearer\s+[A-Za-z0-9+/]{40,}={0,2}"
)

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|tsx|json|env|txt)$' | grep -v '.env.example')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
  FOUND=$(echo "$STAGED_FILES" | xargs -I {} git diff --cached {} | grep -E "$pattern" || true)
  
  if [ ! -z "$FOUND" ]; then
    echo "âŒ Potential sensitive information detected!"
    echo "Pattern: $pattern"
    echo "Please remove sensitive data before committing."
    echo ""
    echo "Tips:"
    echo "- Use environment variables for secrets"
    echo "- Add sensitive files to .gitignore"
    echo "- Use .env.example for templates"
    exit 1
  fi
done

# ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
FORBIDDEN_FILES=(
  ".env"
  ".env.local"
  ".env.production"
  "cookies.txt"
  "*.pem"
  "*.key"
  "*.cert"
)

for file in "${FORBIDDEN_FILES[@]}"; do
  if echo "$STAGED_FILES" | grep -q "$file"; then
    echo "âŒ Forbidden file detected: $file"
    echo "This file should not be committed!"
    exit 1
  fi
done

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
echo "ğŸ§ª Running tests..."
npm test -- --passWithNoTests

echo "âœ… Pre-commit checks passed!"
